name: Contract Testing Example
description: Demonstrates Pact-compatible contract testing with TestMesh
suite: examples
tags:
  - contract-testing
  - pact
  - example

env:
  CONSUMER_NAME: web-client
  PROVIDER_NAME: user-api
  CONTRACT_VERSION: 1.0.0
  PROVIDER_BASE_URL: http://localhost:5016

steps:
  # Consumer side: Make HTTP requests and generate contract
  - id: get_users
    action: http_request
    name: "Consumer: Get list of users"
    config:
      method: GET
      url: "{{PROVIDER_BASE_URL}}/api/users"
      headers:
        Accept: application/json
    assert:
      - status == 200
      - body.users != null
    output:
      first_user_id: $.body.users[0].id

  - id: get_user_by_id
    action: http_request
    name: "Consumer: Get user by ID"
    config:
      method: GET
      url: "{{PROVIDER_BASE_URL}}/api/users/{{first_user_id}}"
      headers:
        Accept: application/json
    assert:
      - status == 200
      - body.id == first_user_id
      - body.name != null
      - body.email != null

  - id: create_user
    action: http_request
    name: "Consumer: Create new user"
    config:
      method: POST
      url: "{{PROVIDER_BASE_URL}}/api/users"
      headers:
        Content-Type: application/json
        Accept: application/json
      body:
        name: Alice Smith
        email: alice.smith@example.com
    assert:
      - status == 201
      - body.id != null
      - body.name == "Alice Smith"
      - body.email == "alice.smith@example.com"
    output:
      created_user_id: $.body.id

  # Generate contract from recorded interactions
  - id: generate_contract
    action: contract_generate
    name: Generate Pact contract from interactions
    config:
      consumer: "{{CONSUMER_NAME}}"
      provider: "{{PROVIDER_NAME}}"
      version: "{{CONTRACT_VERSION}}"
      export_json: true
    output:
      contract_id: $.contract_id
      pact_json: $.pact_json

  - id: log_contract_generated
    action: log
    name: Log contract generation
    config:
      message: "Contract generated successfully!"
      data:
        contract_id: "{{contract_id}}"
        consumer: "{{CONSUMER_NAME}}"
        provider: "{{PROVIDER_NAME}}"
        version: "{{CONTRACT_VERSION}}"

  # Provider side: Verify provider implementation against contract
  - id: verify_contract
    action: contract_verify
    name: Verify provider against contract
    config:
      contract_id: "{{contract_id}}"
      provider_base_url: "{{PROVIDER_BASE_URL}}"
      provider_version: 1.0.0
    output:
      verification_id: $.verification_id
      verification_status: $.status
      passed_interactions: $.passed_interactions
      failed_interactions: $.failed_interactions
      summary: $.summary

  - id: assert_verification
    action: assert
    name: Assert contract verification passed
    config:
      expression: "{{verification_status}} == 'passed'"

  - id: log_verification_complete
    action: log
    name: Log verification results
    config:
      message: "Contract verification completed"
      data:
        verification_id: "{{verification_id}}"
        status: "{{verification_status}}"
        passed: "{{passed_interactions}}"
        failed: "{{failed_interactions}}"
        summary: "{{summary}}"
