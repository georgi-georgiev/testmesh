name: "User Search and Pagination"
description: "List users, search by name, fetch a specific user, cross-check count with Postgres"
suite: "users"
tags: [api, smoke]
collection: "User API Tests"
steps:
  - id: list_users
    action: http_request
    name: "GET /api/users — List all users"
    config:
      method: GET
      url: "${USER_SERVICE_URL}/api/users"
      headers:
        X-API-Key: "${API_KEY}"
    assert:
      - "status == 200"
    output:
      total: "list_users.body.total"

  - id: search
    action: http_request
    name: "GET /api/search?q=Alice — Search users"
    config:
      method: GET
      url: "${USER_SERVICE_URL}/api/search?q=Alice"
      headers:
        X-API-Key: "${API_KEY}"
    assert:
      - "status == 200"

  - id: get_user
    action: http_request
    name: "GET /api/users/user-001 — Fetch specific user"
    config:
      method: GET
      url: "${USER_SERVICE_URL}/api/users/user-001"
      headers:
        X-API-Key: "${API_KEY}"
    assert:
      - "status == 200"
    output:
      fetched_id: "get_user.body.id"

  - id: db_count
    action: database_query
    name: "Cross-check user count in Postgres"
    config:
      connection: "${DB_DSN}"
      query: "SELECT COUNT(*) AS total FROM users WHERE active = true"
    output:
      db_total: "db_count.first_row.total"

  - id: assert_users
    action: assert
    name: "Assert user API responses"
    config:
      data:
        list_status: "${list_users.status}"
        user_status: "${get_user.status}"
      assertions:
        - "list_status == '200'"
        - "user_status == '200'"

  - id: done
    action: log
    name: "Log user search results"
    config:
      message: "Search OK: api_total=${list_users.body.total} db_total=${db_count.first_row.total} fetched_id=${get_user.body.id}"
      level: info
