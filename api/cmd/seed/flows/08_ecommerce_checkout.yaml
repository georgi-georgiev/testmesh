name: "E-commerce Checkout"
description: "Full checkout: login, create order, process payment, send confirmation email, verify in Postgres"
suite: "e-commerce"
tags: [critical, e2e, integration]
collection: "E-commerce Flows"
steps:
  - id: login
    action: http_request
    name: "POST /api/login — Authenticate customer"
    config:
      method: POST
      url: "${USER_SERVICE_URL}/api/login"
      headers:
        Content-Type: application/json
      body:
        email: "bob@example.com"
        password: "secret123"
    assert:
      - "login.status == 200"
    output:
      token: "login.body.token"

  - id: create_order
    action: http_request
    name: "POST /api/orders — Create cart order"
    config:
      method: POST
      url: "${ORDER_SERVICE_URL}/api/orders"
      headers:
        Content-Type: application/json
        Authorization: "Bearer ${login.body.token}"
      body:
        user_id: "bob-user-id"
        items:
          - sku: "PROD-A"
            qty: 1
            price: 79.99
          - sku: "PROD-B"
            qty: 3
            price: 9.99
        total: 109.96
    assert:
      - "create_order.status == 201"
    output:
      order_id: "create_order.body.id"

  - id: pay
    action: http_request
    name: "POST /api/payments — Process payment"
    config:
      method: POST
      url: "${PAYMENT_SERVICE_URL}/api/payments"
      headers:
        Content-Type: application/json
        Authorization: "Bearer ${login.body.token}"
      body:
        order_id: "${create_order.body.id}"
        amount: 109.96
        currency: USD
        method: card
    assert:
      - "pay.status == 200"
    output:
      payment_id: "pay.body.id"

  - id: notify
    action: http_request
    name: "POST /api/notifications/email — Order confirmation"
    config:
      method: POST
      url: "${NOTIFICATION_SERVICE_URL}/api/notifications/email"
      headers:
        Content-Type: application/json
      body:
        to: "bob@example.com"
        subject: "Order Confirmed"
        body: "Payment ${pay.body.id} succeeded. Total: $109.96"
    assert:
      - "notify.status == 202"

  - id: verify_db
    action: database_query
    name: "SELECT order count from Postgres"
    config:
      connection: "${DB_DSN}"
      query: "SELECT COUNT(*) AS cnt FROM orders WHERE external_id = $1"
      params:
        - "${create_order.body.id}"

  - id: assert_checkout
    action: assert
    name: "Assert checkout complete"
    config:
      data:
        order_status: "${create_order.status}"
        pay_status: "${pay.status}"
        pay_result: "${pay.body.status}"
        notify_status: "${notify.status}"
      assertions:
        - "order_status == '201'"
        - "pay_status == '200'"
        - "pay_result == 'succeeded'"
        - "notify_status == '202'"

  - id: done
    action: log
    name: "Log checkout summary"
    config:
      message: "Checkout done: order=${create_order.body.id} payment=${pay.body.id} notify=${notify.status}"
      level: info
